version: '3'
services:
  mock-oauth2-server:
    image: ghcr.io/navikt/mock-oauth2-server:0.5.5
    hostname: host.docker.internal
    ports:
      - "8233:8233"
    environment:
      SERVER_PORT: 8233
      JSON_CONFIG: '{
        "interactiveLogin": true,
        "tokenCallbacks": [
          {
            "issuerId": "idporten",
            "tokenExpiry": 60,
            "requestMappings": [
              {
                "requestParam": "grant_type",
                "claims": {
                  "sub": "04010100653",
                  "pid": "04010100653",
                  "aud": [
                            "local-token-x-client-id"
                        ]
                }
              }
            ]
          }
        ]
      }'

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  pam-stillingsok:
    image: pam-stillingsok
    environment:
    - PAMADUSER_URL=http://localhost:9017
    - PAM_STILLINGSOK_URL=http://localhost:8080/stillinger
    - PAMSEARCHAPI_URL=https://pam-search-api.nais.oera-q.local
    # OK/Only for development
    - NODE_TLS_REJECT_UNAUTHORIZED=0
    build: .
    command: [sh, -c, "npm start"]
    volumes:
    - .:/usr/src/app
    ports:
    - "8080:8080"
    depends_on:
    - pam-aduser

  pam-stillingsok-webpack:
    image: pam-stillingsok
    command: [sh, -c, "npm run start-webpack"]
    volumes:
    - .:/usr/src/app
    depends_on:
    - pam-stillingsok

  pam-aduser:
    environment:
    - NO_NAV_SECURITY_OIDC_ISSUER_SELVBETJENING_ACCEPTEDAUDIENCE=aud-localhost
    - NO_NAV_SECURITY_OIDC_ISSUER_SELVBETJENING_DISCOVERYURL=http://oidc-test:9018/local/metadata
    - NO_NAV_PAM_ADUSER_ADURL=http://localhost:8080/stillinger/stilling
    - NO_NAV_PAM_ADUSER_URLTOSEARCHPAGE=http://localhost:8080/stillinger/
    - NO_NAV_PAM_ADUSER_ALLOWED_ORIGINS=http://localhost:8080
    - NO_NAV_PAM_ADUSER_SEARCHURL=http://localhost:8080/stillinger/api/search
    - NAV_TRUSTSTORE_PATH=/nav_truststore.jts
    - NAV_TRUSTSTORE_PASSWORD=changeit
    - PAMADUSER_ARBEIDSPLASSEN_COOKIE_DOMAIN=localhost
    - PAMADUSER_ARBEIDSPLASSEN_COOKIE_SECURE=false
    build: ../pam-aduser/.
    ports:
    - "9017:9017"
