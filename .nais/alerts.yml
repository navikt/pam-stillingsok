apiVersion: "monitoring.coreos.com/v1"
kind: "PrometheusRule"
metadata:
  name: "stillingsok-alerts"
  namespace: "arbeidsplassen"
  labels:
    team: "arbeidsplassen"
spec:
  groups:
  - name: "teampam stillingsok alerts"
    rules:
    - alert: "[pam-stillingsok] OpenSearch virker treg (over 750 ms gjennomsnittlig responstid)"
      expr: avg(rate(elastic_search_duration_seconds_sum{app="pam-stillingsok"}[1m])) > 0.75
      for: 10m
      annotations:
        action: "Sjekk loggene for å se hvorfor søket er tregt"
      labels:
        namespace: "arbeidsplassen"
        severity: warning

    - alert: "[pam-stillingsok] OpenSearch suggestions virker treg (over 300 ms gjennomsnittlig responstid)"
      expr: avg(rate(suggestion_duration_seconds_sum{app="pam-stillingsok"}[3m])) > 0.3
      for: 10m
      annotations:
        action: "Sjekk loggene for å se hvorfor søkforslag er tregt"
      labels:
        namespace: "arbeidsplassen"
        severity: warning

    - alert: "[pam-stillingsok] Ingen kall til OpenSearch på lang tid, er søket nede?"
      expr: sum(rate(elastic_search_requests{app="pam-stillingsok"}[3m])) == 0
      for: 10m
      annotations:
        action: "Sjekk loggene for å se om det er noe feil "
      labels:
        namespace: "arbeidsplassen"
        severity: critical

    - alert: "[pam-stillingsok] Kall til pam-aduser feiler"
      expr: (100 * (sum(rate(aduser_requests{app="pam-stillingsok", result="failure"}[3m]))) / (sum(rate(aduser_requests{app="pam-stillingsok"}[3m])))) > 5
      for: 3m
      annotations:
        action: "Sjekk loggene for å se hvorfor så mange kall til pam-aduser feiler"
      labels:
        namespace: "arbeidsplassen"
        severity: critical

    - alert: "[pam-stillingsok] Kall til OpenSearch feiler"
      expr: (100 * (sum(rate(elastic_search_requests{app="pam-stillingsok", result="failure"}[3m]))) / (sum(rate(elastic_search_requests{app="pam-stillingsok"}[3m])))) > 5
      for: 3m
      annotations:
        action: "Sjekk loggene for å se hvorfor så mange kall til OpenSearch feiler"
      labels:
        namespace: "arbeidsplassen"
        severity: critical

    - alert: "[pam-stillingsok] Kall til OpenSearch suggestions feiler"
      expr: (100 * (sum(rate(suggestion_requests{app="pam-stillingsok", result="failure"}[3m]))) / (sum(rate(suggestion_requests{app="pam-stillingsok"}[3m])))) > 5
      for: 3m
      annotations:
        action: "Sjekk loggene for å se hvorfor så mange kall til OpenSearch suggestions feiler"
      labels:
        namespace: "arbeidsplassen"
        severity: critical
